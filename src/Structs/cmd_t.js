/* eslint-disable no-unused-expressions */
const { Struct } = require('struct');
const { create_var_t } = require('./var_t');

const var_t = create_var_t();

// 88888888 04CC0120 2000 00000000 0000 3442 0000 34420000344200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999
// 88888888 04cc0120 2000 aaaaaaaa 0000 f042 0020 81450000803f003aa44600000000000000000000010101010000bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999
// 88888888 04CC0120 2000 00000000 0000 3442 0000 34420000344200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999
// 88888888 04cc0120 2000 00000000 0000 0042 0000 c4420000204100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999
// AAAAAAAA0000000000000000000000000000000000000000000000000000010101010000BBBBBBBB
// aaaaaaaa0000f042002081450000f0420080ac4300000000000000000000010101010000bbbbbbbb

function create_cmd_t() {
  const cmdData = new Struct()
    .word32Ule('BlkBegCmd')
    .word32Ule('CmdMemAdr')
    .word16Ule('CmdMemLen')
    .array('CmdMemVal', 1, var_t)
    .chars('filler', 144)
    .word32Ule('BlkEndCmd');
  cmdData.allocate();
  const buf = cmdData.buffer();
  const { fields } = cmdData;
  fields.CmdMemVal[0].BlkBegVar = 0xAAAAAAAA;
  fields.CmdMemVal[0].BlkEndVar = 0xBBBBBBBB;
  fields.BlkBegCmd = 0x88888888;
  fields.CmdMemAdr = 0x2001CC04;
  fields.CmdMemLen = 0x20;
  fields.BlkEndCmd = 0x99999999;
  return cmdData;
}

const cmd_t = create_cmd_t();
let dataToSend = 1;

function update_cmd_t(data) {
  const {
    MdlManChr, MdlManInj, MdlManCdr, MdlManCar, MdlExhAcv, MdlMisAcv, MdlIgnAcv, MdlAlmAcv,
  } = data;

  MdlManChr && (cmd_t.fields.CmdMemVal[0].MdlManChr = MdlManChr);
  MdlManInj && (cmd_t.fields.CmdMemVal[0].MdlManInj = MdlManInj);
  MdlManCdr && (cmd_t.fields.CmdMemVal[0].MdlManCdr = MdlManCdr);
  MdlManCar && (cmd_t.fields.CmdMemVal[0].MdlManCar = MdlManCar);
  cmd_t.fields.CmdMemVal[0].MdlExhAcv = 1;
  cmd_t.fields.CmdMemVal[0].MdlMisAcv = 1;
  cmd_t.fields.CmdMemVal[0].MdlIgnAcv = 1;
  cmd_t.fields.CmdMemVal[0].MdlAlmAcv = 1;
  console.log(cmd_t.buffer().toString('hex'));
  dataToSend = dataToSend ? 0 : 1;
}

function send_cmd_t() {
  const buf = cmd_t.buffer();
  return buf;
}

module.exports = { create_cmd_t, update_cmd_t, send_cmd_t };
