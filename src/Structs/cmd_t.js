const { Struct } = require('struct');
const { create_var_t } = require('./var_t');

const var_t = create_var_t();

// 8888888804CC0120200000000000 0000 3442000034420000344200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999
// 8888888804cc01202000aaaaaaaa 0000 f042002081450000803f003aa44600000000000000000000010101010000bbbbbbbb00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999
// 88888888 04CC0120 2000 000000000000 3442 000034420000344200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999
// 88888888 04cc0120 2000 000000000000 00420000c4420000204100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999
// AAAAAAAA0000000000000000000000000000000000000000000000000000010101010000BBBBBBBB
// aaaaaaaa0000f042002081450000f0420080ac4300000000000000000000010101010000bbbbbbbb

function create_cmd_t() {
  const cmdData = new Struct()
    .word32Ule('BlkBegCmd')
    .word32Ule('CmdMemAdr')
    .word16Ule('CmdMemLen')
    .array('CmdMemVal', 1, var_t)
    .chars('filler', 144)
    .word32Ule('BlkEndCmd');
  cmdData.allocate();
  const buf = cmdData.buffer();
  const { fields } = cmdData;
  fields.CmdMemVal[0].BlkBegVar = 0xAAAAAAAA;
  fields.CmdMemVal[0].BlkEndVar = 0xBBBBBBBB;
  fields.BlkBegCmd = 0x88888888;
  fields.CmdMemAdr = 0x2001CC04;
  fields.CmdMemLen = 0x20;
  fields.BlkEndCmd = 0x99999999;
  return cmdData;
}

const cmdStruct = create_cmd_t();
let dataToSend = 1;

function update_cmd_t(data) {
  const {
    MdlManChr, MdlManInj, MdlManCdr, MdlManCar, MdlExhAcv, MdlMisAcv, MdlIgnAcv, MdlAlmAcv,
  } = data;

  console.log(MdlManCar);
  cmdStruct.fields.CmdMemVal[0].MdlManChr = 100;
  cmdStruct.fields.CmdMemVal[0].MdlManInj = 100;
  cmdStruct.fields.CmdMemVal[0].MdlManCdr = 100;
  cmdStruct.fields.CmdMemVal[0].MdlManCar = 100;
  cmdStruct.fields.CmdMemVal[0].MdlExhAcv = dataToSend;
  cmdStruct.fields.CmdMemVal[0].MdlMisAcv = dataToSend;
  cmdStruct.fields.CmdMemVal[0].MdlIgnAcv = dataToSend;
  cmdStruct.fields.CmdMemVal[0].MdlAlmAcv = dataToSend;
  console.log(cmdStruct.buffer().toString('hex'));
  dataToSend = dataToSend ? 0 : 1;
}

function send_cmd_t() {
  const buf = cmdStruct.buffer();
  return buf;
}

module.exports = { create_cmd_t, update_cmd_t, send_cmd_t };
